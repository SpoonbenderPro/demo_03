<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>WebAR ‚Äî Stick-to-Camera + HUD</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:sans-serif}
    #container{position:fixed;inset:0}
    #hint{position:fixed;left:0;right:0;top:10px;text-align:center;color:#fff;opacity:.9;z-index:3}
    #ui{position:fixed;left:12px;right:12px;bottom:12px;z-index:4;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    button,a.button{padding:10px 14px;border:0;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;background:#4f46e5;color:#fff;text-decoration:none}
    button.secondary{background:#374151}
    #hiddenVideo{display:none}
    #nudge{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;z-index:5;color:#fff;background:#000a;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);display:none}

    /* Loading overlay (for camera init / restart) */
    #loading {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.85);
      color:#fff;
      font-size:18px;
      z-index:10;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.25s ease;
    }
    #loading.visible {
      opacity:1;
      pointer-events:auto;
    }
    #loading .spinner {
      border-radius:50%;
      width:32px;
      height:32px;
      border:4px solid rgba(255,255,255,0.3);
      border-top-color:#fff;
      margin-right:10px;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="hint">Point your camera at the target image</div>
  <div id="container"></div>

  <!-- Loading UI -->
  <div id="loading">
    <div class="spinner"></div>
    <div>Initializing camera‚Ä¶</div>
  </div>

  <video id="hiddenVideo" src="./promo.mp4" playsinline webkit-playsinline muted preload="none"></video>

  <div id="ui">
    <button id="startBtn">Start AR</button>
    <button id="muteBtn" class="secondary">Unmute</button>
    <button id="restartBtn" class="secondary">Restart</button>
    <a id="ctaBtn" class="button" href="#" target="_blank" rel="noopener">Visit Site</a>
  </div>

  <div id="nudge">üîä Tap ‚ÄúUnmute‚Äù to enable audio</div>

  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-image-three';

    const CTA_URL = 'http://cgculture.in/';
    document.getElementById('ctaBtn').href = CTA_URL;

    // DOM elements
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const muteBtn = document.getElementById('muteBtn');
    const videoEl = document.getElementById('hiddenVideo');
    const hint = document.getElementById('hint');
    const nudge = document.getElementById('nudge');
    const loadingOverlay = document.getElementById('loading');

    // State
    let sessionStarted = false;
    let hasFoundTarget = false;

    // Ensure paused & muted initially
    videoEl.pause();
    videoEl.muted = true;

    // MindAR setup
    const mindar = new MindARThree({
      container,
      imageTargetSrc: './targets.mind',
      uiLoading: 'no',
      uiScanning: 'no',
      uiError: 'no',
      warmupTolerance: 2,
      missTolerance: 8,
      filterMinCF: 0.0001,
      filterBeta: 0.01,
      smoothFactor: 0.8
    });
    const { renderer, scene, camera } = mindar;
    renderer.setClearColor(0x000000, 0);
    renderer.autoClear = false; // we'll clear manually each frame
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    // Main video plane (on the target)
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(16/9, 1),
      new THREE.MeshBasicMaterial({ side: THREE.DoubleSide, toneMapped:false })
    );
    plane.scale.set(1.0/(16/9), 0.56/1.0, 1);
    plane.visible = false;

    // HUD scene for "stick to screen" mode
    const hudScene = new THREE.Scene();
    const hudCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 10);
    hudCamera.position.z = 1;
    hudCamera.lookAt(0, 0, 0);

    const hudPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(1.5, 0.9),
      new THREE.MeshBasicMaterial({
        side: THREE.DoubleSide,
        transparent: true,
        depthTest: false,
        depthWrite: false
      })
    );
    hudPlane.position.set(0, 0, 0);
    hudPlane.visible = false;
    hudScene.add(hudPlane);

    const anchor = mindar.addAnchor(0);
    anchor.group.add(plane);

    // ====== ANCHOR EVENTS ======
    anchor.onTargetFound = async () => {
      hint.textContent = 'Tracking ‚úì';
      plane.visible = true;
      hudPlane.visible = false;   // hide HUD, show AR plane

      if (!sessionStarted) return;

      hasFoundTarget = true;

      // Start / resume video when the image is actually found
      if (videoEl.paused) {
        try {
          await videoEl.play();
        } catch (e) {
          // Autoplay with sound blocked ‚Üí play muted & nudge user
          videoEl.muted = true;
          setMuteUI();
          try { await videoEl.play(); } catch {}
          showNudge();
        }
      }
    };

    anchor.onTargetLost = () => {
      hint.textContent = 'Lost target ‚Üí keeping video on screen';

      // Hide marker plane and show HUD plane
      plane.visible = false;
      hudPlane.visible = true;

      // IMPORTANT: we do NOT pause ‚Üí video keeps playing
    };

    // ====== UI HELPERS ======
    const setMuteUI = () => {
      muteBtn.textContent = videoEl.muted ? 'Unmute' : 'Mute';
    };

    const showNudge = () => {
      nudge.style.display = 'block';
      setTimeout(() => { nudge.style.display = 'none'; }, 2000);
    };

    const showLoading = () => loadingOverlay.classList.add('visible');
    const hideLoading = () => loadingOverlay.classList.remove('visible');

    setMuteUI();

    // ====== BUTTON HANDLERS ======
    muteBtn.addEventListener('click', () => {
      // Only toggle mute, do NOT auto-play here
      videoEl.muted = !videoEl.muted;
      setMuteUI();
    });

    restartBtn.addEventListener('click', async () => {
      showLoading();
      try {
        try { await mindar.stop(); } catch {}
        await mindar.start();
      } catch (e) {
        console.error(e);
      } finally {
        hideLoading();
      }
    });

    startBtn.addEventListener('click', async () => {
      // Shared video texture for both AR plane & HUD plane
      const videoTex = new THREE.VideoTexture(videoEl);
      videoTex.encoding = THREE.sRGBEncoding;
      plane.material.map = videoTex;
      hudPlane.material.map = videoTex;

      videoEl.loop = true;
      videoEl.pause();  // only play when target found

      startBtn.disabled = true;
      startBtn.textContent = 'Starting‚Ä¶';
      showLoading();

      try {
        await mindar.start();
        sessionStarted = true;

        renderer.setAnimationLoop(() => {
          renderer.clear(); // clear color+depth

          if (videoEl.readyState >= videoEl.HAVE_CURRENT_DATA) {
            videoTex.needsUpdate = true;
          }

          // Render AR scene
          renderer.render(scene, camera);

          // Render HUD on top if visible
          if (hudPlane.visible) {
            renderer.render(hudScene, hudCamera);
          }
        });

        startBtn.textContent = 'Running‚Ä¶';
      } catch (e) {
        console.error(e);
        startBtn.disabled = false;
        startBtn.textContent = 'Start AR (Retry)';
      } finally {
        hideLoading();
      }

      // Safety: if target was already found somehow
      if (hasFoundTarget && videoEl.paused) {
        try { await videoEl.play(); } catch {}
      }
    });

    // ====== RESIZE HANDLING ======
    const ro = new ResizeObserver(() => {
      renderer.setSize(container.clientWidth, container.clientHeight, false);
    });
    ro.observe(container);
  </script>
</body>
</html>
